---
# Configure Netdata to collect Consul metrics using the Prometheus token

- name: Configure Netdata Consul collector
  hosts: all
  become: true
  gather_facts: false

  vars:
    prometheus_token: "73d098e0-3dda-a9d9-e9e2-4756ee1334e4"
    consul_addr: "http://127.0.0.1:8500"

  tasks:
    - name: Check if Netdata is installed
      stat:
        path: /etc/netdata
      register: netdata_dir

    - name: Configure Netdata when installed
      when: netdata_dir.stat.exists
      block:
        - name: Create go.d configuration directory
          file:
            path: /etc/netdata/go.d
            state: directory
            mode: '0755'
            owner: netdata
            group: netdata

        - name: Create Consul collector configuration
          copy:
            content: |
              # Netdata Consul collector configuration
              # Generated by Ansible

              jobs:
                - name: local
                  url: {{ consul_addr }}
                  acl_token: "{{ prometheus_token }}"
                  # Update interval in seconds
                  update_every: 1
                  # Timeout for API requests
                  timeout: 2
                  # Enable autodetection of services
                  autodetection_retry: 0
                  # Collect additional metrics
                  collect_node_metadata: yes
                  collect_service_metadata: yes
            dest: /etc/netdata/go.d/consul.conf
            mode: '0640'
            owner: netdata
            group: netdata
            backup: yes

        - name: Restart Netdata
          service:
            name: netdata
            state: restarted

    - name: Wait for Netdata to start
      wait_for:
        port: 19999
        delay: 3
      when: netdata_dir.stat.exists

    - name: Test Consul connectivity with token
      uri:
        url: "{{ consul_addr }}/v1/agent/metrics?format=prometheus"
        headers:
          X-Consul-Token: "{{ prometheus_token }}"
        validate_certs: false
      register: consul_test
      failed_when: false

    - name: Report status
      debug:
        msg: |
          Host: {{ inventory_hostname }}
          Netdata installed: {{ 'Yes' if netdata_dir.stat.exists else 'No' }}
          Consul metrics accessible: {{ 'Yes' if consul_test.status == 200 else 'No' }}

- name: Generate summary report
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Create configuration report
      copy:
        content: |
          Netdata Consul Configuration Report
          ==================================
          Date: {{ lookup('pipe', 'date -u +"%Y-%m-%d %H:%M:%S UTC"') }}

          Token Used: 73d098e0-3dda-a9d9-e9e2-4756ee1334e4

          Configuration Status:
          {% for host in groups['all'] %}
          - {{ host }}:
            - Netdata: {{ 'Installed' if hostvars[host]['netdata_dir']['stat']['exists'] else 'Not installed' }}
            - Consul API: {{ 'Accessible' if hostvars[host]['consul_test']['status'] == 200 else 'Not accessible' }}
          {% endfor %}

          Next Steps:
          1. Verify metrics in Netdata dashboard (http://<host>:19999)
          2. Look for consul.* metrics
          3. Store the token in Infisical at /apollo-13/consul/PROMETHEUS_SCRAPING_TOKEN
        dest: reports/netdata-consul-config-{{ lookup('pipe', 'date +%Y-%m-%d') }}.txt
      delegate_to: localhost
