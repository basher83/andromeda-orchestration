---
- name: Deploy SSH Keys to og-homelab
  hosts: all
  vars:
    ansible_user: root
    ansible_password: bluegatofeline
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
  tasks:
    - name: Get staging SSH public key from doggos-homelab host
      delegate_to: localhost
      ansible.builtin.command: >
        ssh ansible@192.168.10.12
        'cat ~/.ssh/authorized_keys | head -1'
      register: staging_key
      changed_when: false
      run_once: true

    - name: Create ansible user
      ansible.builtin.user:
        name: ansible
        shell: /bin/bash
        create_home: true
        state: present

    - name: Create SSH directory for ansible user
      ansible.builtin.file:
        path: /home/ansible/.ssh
        state: directory
        owner: ansible
        group: ansible
        mode: '0700'

    - name: Deploy SSH key to ansible user
      ansible.posix.authorized_key:
        user: ansible
        key: "{{ staging_key.stdout }}"
        state: present

    - name: Add ansible user to sudoers
      ansible.builtin.lineinfile:
        path: /etc/sudoers.d/ansible
        line: 'ansible ALL=(ALL) NOPASSWD:ALL'
        create: true
        validate: 'visudo -cf %s'
        mode: '0440'

    - name: Test SSH connectivity with ansible user
      delegate_to: localhost
      ansible.builtin.command: >
        ssh -o BatchMode=yes -o ConnectTimeout=5
        ansible@{{ inventory_hostname }} 'echo Connected'
      register: ssh_test
      changed_when: false
      failed_when: false

    - name: Report SSH test results
      ansible.builtin.debug:
        msg: >
          SSH test {{ 'passed' if ssh_test.rc == 0 else 'failed' }}
          for {{ inventory_hostname }}
