---
# Deploy TLS Certificates to Vault Master
# Part of Issue #99: Migrate vault-master-lloyd to Production Mode
#
# This playbook generates and deploys TLS certificates from the Vault PKI
# for the production vault-master-lloyd instance.

- name: Deploy TLS Certificates for Production Vault Master
  hosts: vault-master-lloyd
  gather_facts: true
  become: yes
  vars:
    vault_tls_dir: /opt/vault/tls
    vault_backup_dir: /opt/vault/tls/backup-{{ ansible_date_time.epoch }}

    # Active Vault leader for PKI operations - derive from inventory with IPv6 safety
    _vault_leader_host: "{{ hostvars[(groups.get('vault_production', []) | first)] | default({'ansible_host': ''}) }}"
    vault_leader_addr: >-
      {{ ansible_env.VAULT_ADDR | default(
           ('https://[' ~ _vault_leader_host.ansible_host ~ ']:8200')
           if (_vault_leader_host.ansible_host | ansible.utils.ipaddr('ipv6'))
           else ('https://' ~ _vault_leader_host.ansible_host ~ ':8200'),
           true
         ) }}

# vault_token will be retrieved via secure task

    # Certificate parameters
    cert_common_name: 'vault-master-lloyd.vault.spaceships.work'
    cert_alt_names:
      - 'vault-master-lloyd'
      - 'vault.service.consul'
      - 'vault-transit.service.consul'
      - 'localhost'
    cert_ip_sans:
      - '{{ ansible_default_ipv4.address }}'
      - '127.0.0.1'
    cert_ttl: '8760h' # 1 year for transit master

  pre_tasks:
    - name: Preflight | Validate no hardcoded IPs in play vars
      ansible.builtin.include_tasks: "{{ playbook_dir }}/../../../tasks/validate-no-hardcoded-ips.yml"
      vars:
        validate_hostlike_vars:
          vault_leader_addr: "{{ vault_leader_addr | default('') }}"
        validate_allowlist: []
      tags: [preflight]

    - name: Retrieve Vault token securely
      ansible.builtin.include_tasks: "{{ playbook_dir }}/../../../tasks/infisical-secret-lookup.yml"
      vars:
        secret_name: 'VAULT_PROD_ROOT_TOKEN'
        secret_var_name: 'vault_token'
        fallback_env_var: 'VAULT_TOKEN'
      tags: [secrets]

  tasks:
    - name: Create TLS directories
      ansible.builtin.file:
        path: '{{ item }}'
        state: directory
        owner: vault
        group: vault
        mode: '0750'
      loop:
        - '{{ vault_tls_dir }}'
        - '{{ vault_backup_dir }}'

    - name: Check for existing certificates
      ansible.builtin.stat:
        path: '{{ vault_tls_dir }}/tls.crt'
      register: existing_cert

    - name: Backup existing certificates
      ansible.builtin.copy:
        src: '{{ vault_tls_dir }}/{{ item }}'
        dest: '{{ vault_backup_dir }}/{{ item }}'
        remote_src: yes
        owner: vault
        group: vault
        mode: '0600'
      loop:
        - tls.crt
        - tls.key
        - ca.crt
      when: existing_cert.stat.exists
      failed_when: false

    - name: Generate certificate from Vault PKI
      community.hashi_vault.vault_pki_generate_certificate:
        url: '{{ vault_leader_addr }}'
        auth_method: token
        token: '{{ vault_token }}'
        role_name: infrastructure
        common_name: '{{ cert_common_name }}'
        alt_names: '{{ cert_alt_names }}'
        ip_sans: '{{ cert_ip_sans }}'
        ttl: '{{ cert_ttl }}'
        engine_mount_point: pki_int
      register: vault_cert
      delegate_to: localhost
      when: vault_token != ''

    - name: Save certificate
      ansible.builtin.copy:
        content: '{{ vault_cert.data.data.certificate }}'
        dest: '{{ vault_tls_dir }}/tls.crt'
        owner: vault
        group: vault
        mode: '0644'
      when: vault_cert is succeeded

    - name: Save private key
      ansible.builtin.copy:
        content: '{{ vault_cert.data.data.private_key }}'
        dest: '{{ vault_tls_dir }}/tls.key'
        owner: vault
        group: vault
        mode: '0600'
      when: vault_cert is succeeded

    - name: Save CA certificate chain
      ansible.builtin.copy:
        content: "{{ vault_cert.data.data.ca_chain | join('\n') }}"
        dest: '{{ vault_tls_dir }}/ca.crt'
        owner: vault
        group: vault
        mode: '0644'
      when: vault_cert is succeeded

    - name: Save issuing CA certificate
      ansible.builtin.copy:
        content: '{{ vault_cert.data.data.issuing_ca }}'
        dest: '{{ vault_tls_dir }}/issuing_ca.crt'
        owner: vault
        group: vault
        mode: '0644'
      when: vault_cert is succeeded

    - name: Create certificate bundle
      ansible.builtin.shell: |
        cat {{ vault_tls_dir }}/tls.crt {{ vault_tls_dir }}/ca.crt > {{ vault_tls_dir }}/cert-bundle.pem
      args:
        creates: '{{ vault_tls_dir }}/cert-bundle.pem'

    - name: Set proper permissions on bundle
      ansible.builtin.file:
        path: '{{ vault_tls_dir }}/cert-bundle.pem'
        owner: vault
        group: vault
        mode: '0644'

    - name: Add CA to system trust store
      ansible.builtin.copy:
        src: '{{ vault_tls_dir }}/ca.crt'
        dest: /usr/local/share/ca-certificates/vault-ca.crt
        remote_src: yes
        mode: '0644'
      notify: update ca certificates

    - name: Verify certificate
      ansible.builtin.shell: |
        set -o pipefail
        openssl x509 -in {{ vault_tls_dir }}/tls.crt -text -noout | grep -E "Subject:|Not After|DNS:|IP Address:"
      register: cert_info
      changed_when: false

    - name: Display certificate information
      ansible.builtin.debug:
        msg: |
          Certificate deployed successfully!

          Certificate Details:
          {{ cert_info.stdout }}

          Certificate locations:
          - Certificate: {{ vault_tls_dir }}/tls.crt
          - Private Key: {{ vault_tls_dir }}/tls.key
          - CA Chain: {{ vault_tls_dir }}/ca.crt
          - Bundle: {{ vault_tls_dir }}/cert-bundle.pem

          {% if existing_cert.stat.exists %}
          Previous certificates backed up to: {{ vault_backup_dir }}
          {% endif %}

          Certificate TTL: {{ cert_ttl }}
          Serial Number: {{ vault_cert.data.data.serial_number | default('N/A') }}

          Next steps:
          1. Start Vault service with new certificates
          2. Verify TLS connectivity
          3. Update Consul health checks

    - name: Create certificate renewal script
      ansible.builtin.copy:
        content: |
          #!/bin/bash
          # Vault Certificate Renewal Script
          # Run this script to renew the certificate before expiry

          set -e

          VAULT_ADDR="{{ vault_leader_addr }}"
          VAULT_TOKEN="${VAULT_TOKEN:-}"
          CERT_DIR="{{ vault_tls_dir }}"
          BACKUP_DIR="${CERT_DIR}/backup-$(date +%s)"

          if [ -z "$VAULT_TOKEN" ]; then
              echo "ERROR: VAULT_TOKEN environment variable not set"
              exit 1
          fi

          echo "Creating backup directory..."
          mkdir -p "$BACKUP_DIR"
          cp -p ${CERT_DIR}/*.{crt,key,pem} "$BACKUP_DIR/" 2>/dev/null || true

          echo "Requesting new certificate from Vault PKI..."
          ansible-playbook /opt/vault/scripts/renew-certificate.yml

          echo "Reloading Vault..."
          systemctl reload vault

          echo "Certificate renewal complete!"
        dest: /opt/vault/scripts/renew-certificate.sh
        mode: '0750'
        owner: vault
        group: vault

  handlers:
    - name: update ca certificates
      ansible.builtin.command: update-ca-certificates
      become: yes
      changed_when: true
