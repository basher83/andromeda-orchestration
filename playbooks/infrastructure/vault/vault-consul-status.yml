---
# Check Vault-Consul integration status
# Usage:
# uv run ansible-playbook playbooks/infrastructure/vault/vault-consul-status.yml \
#   -i inventory/environments/doggos-homelab/proxmox.yml

- name: Check Vault-Consul Integration Status
  hosts: nomad-server-1-lloyd
  gather_facts: false

  pre_tasks:
    - name: Retrieve Consul master token securely
      ansible.builtin.include_tasks: "{{ playbook_dir }}/../../../tasks/infisical-secret-lookup.yml"
      vars:
        secret_name: 'CONSUL_MASTER_TOKEN'
        secret_var_name: 'consul_token'
        fallback_env_var: 'CONSUL_MASTER_TOKEN'
        infisical_path: '/apollo-13/consul'
      tags: [secrets]

  tasks:
    - name: Verify master token is set
      ansible.builtin.assert:
        that:
          - consul_token != ""
        fail_msg: 'Failed to retrieve CONSUL_MASTER_TOKEN from Infisical'
        success_msg: 'Master token verified'

    - name: Get all Vault service nodes
      ansible.builtin.shell: |
        consul catalog nodes -service=vault -token="{{ consul_token }}"
      register: vault_nodes
      changed_when: false
      become: true

    - name: Get healthy Vault services
      ansible.builtin.uri:
        url: '{{ consul_base_url }}/v1/health/service/vault?passing'
        method: GET
        headers:
          X-Consul-Token: '{{ consul_token }}'
        validate_certs: '{{ consul_validate_certs | default(true) }}'
        status_code: 200
      register: healthy_vault
      become: true

    - name: Get all Vault service health details
      ansible.builtin.uri:
        url: '{{ consul_base_url }}/v1/health/service/vault'
        method: GET
        headers:
          X-Consul-Token: '{{ consul_token }}'
        validate_certs: '{{ consul_validate_certs | default(true) }}'
        status_code: 200
      register: all_vault_health
      become: true

    - name: Parse node status
      ansible.builtin.set_fact:
        node_summary: |
          {% for node in all_vault_health.json %}
          {{ '‚úÖ' if node.Checks[1].Status == 'passing' else '‚ùå' }} {{ node.Node.Node }}: {{ node.Checks[1].Status }}
              IP: {{ node.Service.Address }}:{{ node.Service.Port }}
              Tags: {{ node.Service.Tags | join(', ') }}
          {% endfor %}

    - name: Display status summary
      ansible.builtin.debug:
        msg:
          - 'üéâ ==================== VAULT-CONSUL INTEGRATION STATUS ===================='
          - ''
          - '‚úÖ Service Discovery: OPERATIONAL'
          - '   - Total Vault nodes registered: {{ vault_nodes.stdout_lines | length - 1 }}'
          - '   - Healthy nodes: {{ healthy_vault.json | length }}'
          - ''
          - 'üìä Node Status:'
          - '{{ node_summary }}'
          - ''
          - 'üîí Security:'
          - '   - ACL Integration: ‚úÖ Enabled'
          - '   - Individual node tokens: ‚úÖ Configured'
          - '   - Service write permissions: ‚úÖ Granted'
          - ''
          - 'üìù Configuration:'
          - '   - Health check endpoint: http://<node>:8200/v1/sys/health'
          - '   - Check interval: 10s'
          - '   - Check timeout: 5s'
          - ''
          - '============================================================================'
          - ''
          - 'üöÄ All systems operational! Vault services are successfully registered'
          - '   and monitored by Consul with proper ACL permissions.'
