---
# Check Vault-Consul integration status
# Usage: uv run ansible-playbook playbooks/infrastructure/vault/vault-consul-status.yml
#        -i inventory/environments/doggos-homelab/proxmox.yml

- name: Check Vault-Consul Integration Status
  hosts: nomad-server-1-lloyd
  gather_facts: false

  pre_tasks:
    - name: Retrieve Consul master token securely
      ansible.builtin.include_tasks: "{{ playbook_dir }}/../../../tasks/infisical-secret-lookup.yml"
      vars:
        secret_name: 'CONSUL_MASTER_TOKEN'
        secret_var_name: 'consul_token'
        fallback_env_var: 'CONSUL_MASTER_TOKEN'
        infisical_path: '/apollo-13/consul'
      tags: [secrets]

  tasks:
    - name: Verify master token is set
      ansible.builtin.assert:
        that:
          - consul_token != ""
        fail_msg: 'Failed to retrieve CONSUL_MASTER_TOKEN from Infisical'
        success_msg: 'Master token verified'

    - name: List Vault services (catalog)
      ansible.builtin.uri:
        url: 'https://127.0.0.1:8501/v1/catalog/service/vault'
        method: GET
        headers:
          X-Consul-Token: '{{ consul_token }}'
        validate_certs: "{{ consul_validate_certs | default(true) }}"
        status_code: 200
      register: vault_catalog
      become: true
      no_log: true

    - name: Get healthy Vault services
      ansible.builtin.uri:
        url: 'http://127.0.0.1:8500/v1/health/service/vault?passing'
        method: GET
        headers:
          X-Consul-Token: '{{ consul_token }}'
        status_code: 200
      register: healthy_vault
      become: true
      no_log: true

    - name: Get all Vault service health details
      ansible.builtin.uri:
        url: 'http://127.0.0.1:8500/v1/health/service/vault'
        method: GET
        headers:
          X-Consul-Token: '{{ consul_token }}'
        status_code: 200
      register: all_vault_health
      become: true
      no_log: true

    - name: Parse node status
      ansible.builtin.set_fact:
        node_summary: |
          {% for node in all_vault_health.json %}
          {% set passing = (node.Checks | selectattr('Status', 'equalto', 'passing') | list) | length > 0 %}
          {{ 'âœ…' if passing else 'âŒ' }} {{ node.Node.Node }}:
            {{ (node.Checks | map(attribute='Status') | list) | join('/') }}
            IP: {{ node.Service.Address }}:{{ node.Service.Port }}
            Tags: {{ node.Service.Tags | join(', ') }}
          {% endfor %}

    - name: Display status summary
      ansible.builtin.debug:
        msg:
          - 'ğŸ‰ ==================== VAULT-CONSUL INTEGRATION STATUS ===================='
          - ''
          - 'âœ… Service Discovery: OPERATIONAL'
          - '   - Total Vault nodes registered: {{ vault_catalog.json | length }}'
          - '   - Healthy nodes: {{ healthy_vault.json | length }}'
          - ''
          - 'ğŸ“Š Node Status:'
          - '{{ node_summary }}'
          - ''
          - 'ğŸ”’ Security:'
          - '   - ACL Integration: âœ… Enabled'
          - '   - Individual node tokens: âœ… Configured'
          - '   - Service write permissions: âœ… Granted'
          - ''
          - 'ğŸ“ Configuration:'
          - '   - Health check endpoint: http://<node>:8200/v1/sys/health'
          - '   - Check interval: 10s'
          - '   - Check timeout: 5s'
          - ''
          - '============================================================================'
          - ''
          - 'ğŸš€ All systems operational! Vault services are successfully registered'
          - '   and monitored by Consul with proper ACL permissions.'
