---
# Test playbook for the updated Nomad role with Consul ACL integration
# This deploys the Nomad role with proper Consul ACL tokens and KV access

- name: Test Nomad-Consul ACL Integration
  hosts: tag_nomad
  become: true
  vars:
    # Get Consul management token from Infisical
    nomad_consul_management_token: >
      {{ (lookup('infisical.vault.read_secrets',
                 universal_auth_client_id=lookup('env', 'INFISICAL_UNIVERSAL_AUTH_CLIENT_ID'),
                 universal_auth_client_secret=lookup('env', 'INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET'),
                 project_id='7b832220-24c0-45bc-a5f1-ce9794a31259',
                 env_slug='dev',
                 path='/apollo-13/consul',
                 secret_name='CONSUL_MASTER_TOKEN')).value | default('') | trim }}
    
    # Force role to be enabled for all hosts to test
    nomad_consul_integration: true
    nomad_consul_manage_acls: true
    nomad_environment: "dev"
    
    # Set appropriate roles based on host groups  
    nomad_server_enabled: "{{ 'nomad-server' in inventory_hostname }}"
    nomad_client_enabled: "{{ 'nomad-client' in inventory_hostname }}"
    
  tasks:
    - name: Ensure management token is provided
      ansible.builtin.fail:
        msg: |
          Consul management token must be provided!
          
          Set it with one of:
          1. --extra-vars consul_management_token=YOUR_TOKEN
          2. Set vault_consul_management_token in vault/secrets
          3. Export CONSUL_HTTP_TOKEN environment variable
          
          You can get the token from:
          - Initial Consul bootstrap output
          - Infisical at /consul/tokens/management 
          - consul acl token list (with existing access)
      when: nomad_consul_management_token == ""

    - name: Display test configuration
      ansible.builtin.debug:
        msg:
          - "=== Testing Nomad-Consul ACL Integration ==="
          - "Host: {{ inventory_hostname }}"
          - "Nomad Server: {{ nomad_server_enabled | default(false) }}"
          - "Nomad Client: {{ nomad_client_enabled | default(false) }}"
          - "Consul Address: {{ nomad_consul_address | default('127.0.0.1:8500') }}"
          - "ACL Management: {{ nomad_consul_manage_acls }}"

    - name: Deploy Nomad role with Consul ACL integration
      ansible.builtin.include_role:
        name: nomad

    - name: Wait for Nomad service to be ready
      ansible.builtin.wait_for:
        port: 4646
        host: "{{ ansible_default_ipv4.address }}"
        delay: 5
        timeout: 30

- name: Verify Integration on Nomad Clients
  hosts: tag_nomad_client
  tasks:
    - name: Check Nomad agent info
      ansible.builtin.command: nomad agent-info
      register: nomad_info
      changed_when: false

    - name: Display Nomad-Consul integration status
      ansible.builtin.debug:
        msg:
          - "=== Nomad Agent Info (Consul Section) ==="
          - "{{ nomad_info.stdout_lines | select('match', '.*consul.*') | list }}"

    - name: Test KV access by checking if job can access Consul KV
      ansible.builtin.debug:
        msg:
          - "Integration complete! Test with PowerDNS job:"
          - "nomad job run nomad-jobs/platform-services/powerdns-auth.nomad.hcl"
