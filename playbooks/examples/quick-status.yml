---
# Quick Authenticated Status Check for HashiCorp Services
#
# This playbook performs authenticated status checks for Consul, Nomad, and Vault
# to ensure developers can verify both connectivity and authentication.
#
# Usage:
#   uv run ansible-playbook playbooks/assessment/quick-status.yml
#
# Note: Requires INFISICAL_UNIVERSAL_AUTH_CLIENT_ID and INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET environment variables
#
# For unauthenticated connectivity checks, use: mise run status

- name: HashiCorp Services Quick Status Check
  hosts: localhost
  gather_facts: false
  vars:
    # Service endpoints (defined in inventory/environments/all/service-endpoints.yml)
    # These can be overridden via environment variables or extra vars
    consul_addr: "{{ service_endpoints.consul.addr }}"
    nomad_addr: "{{ service_endpoints.nomad.addr }}"
    vault_addr: "{{ service_endpoints.vault.addr }}"

    # Infisical configuration
    infisical_project_id: '7b832220-24c0-45bc-a5f1-ce9794a31259'
    infisical_env: 'prod'

    # Terminal colors for output
    color_green: "\033[32m"
    color_yellow: "\033[33m"
    color_red: "\033[31m"
    color_reset: "\033[0m"

  tasks:
    # ========================================
    # Header
    # ========================================
    - name: Display status check header
      ansible.builtin.debug:
        msg: |
          ====================================================
          ğŸ” HashiCorp Services Authenticated Status Check
          ====================================================

    # ========================================
    # Consul Status Check
    # ========================================
    - name: Check Consul status
      block:
        - name: Retrieve Consul ACL token from Infisical
          ansible.builtin.set_fact:
            consul_token: >-
              {{ (lookup('infisical.vault.read_secrets',
                         universal_auth_client_id=lookup('env', 'INFISICAL_UNIVERSAL_AUTH_CLIENT_ID'),
                         universal_auth_client_secret=lookup('env', 'INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET'),
                         project_id=infisical_project_id,
                         env_slug=infisical_env,
                         path='/apollo-13/consul',
                         secret_name='CONSUL_MASTER_TOKEN')).value }}
          no_log: true
          when: lookup('env', 'CONSUL_HTTP_TOKEN') | default('', true) == ''

        - name: Test Consul connectivity with authentication
          ansible.builtin.uri:
            url: '{{ consul_addr }}/v1/agent/self'
            method: GET
            headers:
              X-Consul-Token: "{{ consul_token | default(lookup('env', 'CONSUL_HTTP_TOKEN')) }}"
            status_code: [200, 403]
          register: consul_result
          ignore_errors: true

        - name: Get Consul leader status
          ansible.builtin.uri:
            url: '{{ consul_addr }}/v1/status/leader'
            method: GET
          register: consul_leader
          ignore_errors: true

        - name: Report Consul status
          ansible.builtin.debug:
            msg: |
              {{ color_green if consul_result.status == 200 else color_red }}ğŸ¥ Consul Status:{{ color_reset }}
              â”œâ”€ Address: {{ consul_addr }}
              â”œâ”€ Connectivity: {{ 'âœ… Connected' if consul_result.status is defined else 'âŒ Cannot connect' }}
              â”œâ”€ Authentication: {{ 'âœ… Valid token' if consul_result.status == 200
                else 'âš ï¸ Invalid token or no ACL' if consul_result.status == 403
                else 'âŒ Failed' }}
              â””â”€ Leader: {{ consul_leader.json | default('Unknown') }}

      rescue:
        - name: Report Consul connection failure
          ansible.builtin.debug:
            msg: |
              {{ color_red }}ğŸ¥ Consul Status:{{ color_reset }}
              â”œâ”€ Address: {{ consul_addr }}
              â””â”€ Status: âŒ Connection failed - {{ ansible_failed_result.msg | default('Unknown error') }}

    # ========================================
    # Nomad Status Check
    # ========================================
    - name: Check Nomad status
      block:
        - name: Retrieve Nomad ACL token from Infisical (if ACLs enabled)
          ansible.builtin.set_fact:
            nomad_token: >-
              {{ (lookup('infisical.vault.read_secrets',
                         universal_auth_client_id=lookup('env', 'INFISICAL_UNIVERSAL_AUTH_CLIENT_ID'),
                         universal_auth_client_secret=lookup('env', 'INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET'),
                         project_id=infisical_project_id,
                         env_slug=infisical_env,
                         path='/apollo-13/nomad',
                         secret_name='NOMAD_TOKEN',
                         errors='ignore') | default({})).value | default('') }}
          no_log: true
          when: lookup('env', 'NOMAD_TOKEN') | default('', true) == ''

        - name: Test Nomad connectivity
          ansible.builtin.uri:
            url: '{{ nomad_addr }}/v1/agent/self'
            method: GET
            headers:
              X-Nomad-Token: "{{ nomad_token | default(lookup('env', 'NOMAD_TOKEN', '')) }}"
            status_code: [200, 403]
          register: nomad_result
          ignore_errors: true

        - name: Get Nomad leader status
          ansible.builtin.uri:
            url: '{{ nomad_addr }}/v1/status/leader'
            method: GET
          register: nomad_leader
          ignore_errors: true

        - name: Get Nomad jobs count
          ansible.builtin.uri:
            url: '{{ nomad_addr }}/v1/jobs'
            method: GET
            headers:
              X-Nomad-Token: "{{ nomad_token | default(lookup('env', 'NOMAD_TOKEN', '')) }}"
          register: nomad_jobs
          ignore_errors: true

        - name: Report Nomad status
          ansible.builtin.debug:
            msg: |
              {{ color_green if nomad_result.status == 200
                else color_yellow if nomad_result.status == 403
                else color_red }}ğŸš€ Nomad Status:{{ color_reset }}
              â”œâ”€ Address: {{ nomad_addr }}
              â”œâ”€ Connectivity: {{ 'âœ… Connected' if nomad_result.status is defined else 'âŒ Cannot connect' }}
              â”œâ”€ Authentication: {{ 'âœ… Valid token' if nomad_result.status == 200
                else 'âš ï¸ ACLs may be disabled' if nomad_result.status == 403
                else 'âŒ Failed' }}
              â”œâ”€ Leader: {{ nomad_leader.json | default('Unknown') }}
              â””â”€ Jobs: {{ nomad_jobs.json | length if nomad_jobs.json is defined else 'Unable to query' }}

      rescue:
        - name: Report Nomad connection failure
          ansible.builtin.debug:
            msg: |
              {{ color_red }}ğŸš€ Nomad Status:{{ color_reset }}
              â”œâ”€ Address: {{ nomad_addr }}
              â””â”€ Status: âŒ Connection failed - {{ ansible_failed_result.msg | default('Unknown error') }}

    # ========================================
    # Vault Status Check
    # ========================================
    - name: Check Vault status
      block:
        - name: Retrieve Vault token from Infisical
          ansible.builtin.set_fact:
            vault_token: >-
              {{ (lookup('infisical.vault.read_secrets',
                         universal_auth_client_id=lookup('env', 'INFISICAL_UNIVERSAL_AUTH_CLIENT_ID'),
                         universal_auth_client_secret=lookup('env', 'INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET'),
                         project_id=infisical_project_id,
                         env_slug=infisical_env,
                         path='/apollo-13/vault',
                         secret_name='VAULT_PROD_ROOT_TOKEN',
                         errors='ignore') | default({})).value | default('') }}
          no_log: true
          when: lookup('env', 'VAULT_TOKEN') | default('', true) == ''

        - name: Get Vault health status
          ansible.builtin.uri:
            url: '{{ vault_addr }}/v1/sys/health'
            method: GET
            status_code: [200, 429, 501, 503]
          register: vault_health
          ignore_errors: true

        - name: Test Vault authentication (if unsealed)
          ansible.builtin.uri:
            url: '{{ vault_addr }}/v1/auth/token/lookup-self'
            method: GET
            headers:
              X-Vault-Token: "{{ vault_token | default(lookup('env', 'VAULT_TOKEN', '')) }}"
            status_code: [200, 403]
          register: vault_auth
          ignore_errors: true
          when: vault_health.status == 200

        - name: Report Vault status
          ansible.builtin.debug:
            msg: |
              {{ color_green if vault_health.status == 200 and vault_auth.status == 200
                else color_yellow if vault_health.status == 503
                else color_red }}ğŸ” Vault Status:{{ color_reset }}
              â”œâ”€ Address: {{ vault_addr }}
              â”œâ”€ Connectivity: {{ 'âœ… Connected' if vault_health.status is defined else 'âŒ Cannot connect' }}
              â”œâ”€ Seal Status: {{ 'âœ… Unsealed' if vault_health.status == 200
                else 'âš ï¸ SEALED' if vault_health.status == 503
                else 'âŒ Error' }}
              â”œâ”€ Authentication: {{ 'âœ… Valid token' if vault_auth.status == 200
                else 'âš ï¸ Invalid/No token' if vault_auth.status == 403
                else 'N/A (sealed)' if vault_health.status == 503
                else 'âŒ Failed' }}
              â””â”€ Version: {{ vault_health.json.version | default('Unknown')
                if vault_health.json is defined else 'Unknown' }}

      rescue:
        - name: Report Vault connection failure
          ansible.builtin.debug:
            msg: |
              {{ color_red }}ğŸ” Vault Status:{{ color_reset }}
              â”œâ”€ Address: {{ vault_addr }}
              â””â”€ Status: âŒ Connection failed - {{ ansible_failed_result.msg | default('Unknown error') }}

    # ========================================
    # Summary
    # ========================================
    - name: Display summary
      ansible.builtin.debug:
        msg: |

          ====================================================
          ğŸ“Š Summary
          ====================================================
          â€¢ Use 'mise run status' for quick connectivity checks
          â€¢ Ensure Infisical credentials are configured for full access
          â€¢ Check ADR-2025-08-27 for implementation details

          For more detailed assessments, run:
          â€¢ ansible-playbook playbooks/assessment/consul-assessment.yml
          â€¢ ansible-playbook playbooks/assessment/infrastructure-readiness.yml
