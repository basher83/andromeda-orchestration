---
- name: Install consul-template
  ansible.builtin.unarchive:
    src: "https://releases.hashicorp.com/consul-template/{{ consul_template_version }}/consul-template_{{ consul_template_version }}_linux_amd64.zip"
    dest: /usr/local/bin
    remote_src: true
    owner: root
    group: root
    mode: '0755'
  when: netdata_consul_template_enabled

- name: Create consul-template configuration directory
  ansible.builtin.file:
    path: /etc/consul-template.d
    state: directory
    mode: '0755'

- name: Create consul-template templates directory
  ansible.builtin.file:
    path: /etc/consul-template.d/templates
    state: directory
    mode: '0755'

- name: Deploy consul-template configuration
  ansible.builtin.template:
    src: consul-template.hcl.j2
    dest: /etc/consul-template.d/netdata.hcl
    mode: '0644'
  notify: restart consul-template

- name: Deploy health alarm templates
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "/etc/consul-template.d/templates/{{ item.name }}"
    mode: '0644'
  loop: "{{ netdata_consul_template_configs }}"
  when: netdata_consul_template_configs is defined
  notify: restart consul-template

- name: Create consul-template systemd service
  ansible.builtin.template:
    src: consul-template.service.j2
    dest: /etc/systemd/system/consul-template.service
    mode: '0644'
  notify:
    - reload systemd
    - restart consul-template

- name: Start and enable consul-template
  ansible.builtin.systemd:
    name: consul-template
    state: started
    enabled: true
    daemon_reload: true

- name: Populate initial KV values in Consul
  ansible.builtin.uri:
    url: "{{ netdata_consul_url }}/v1/kv/{{ item.key }}"
    method: PUT
    body: "{{ item.value }}"
    headers:
      X-Consul-Token: "{{ netdata_consul_acl_token | default(omit) }}"
  loop: "{{ netdata_consul_kv_defaults }}"
  when:
    - netdata_consul_kv_defaults is defined
    - netdata_consul_template_populate_kv | default(false)
