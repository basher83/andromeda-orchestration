# Netdata health alerts for Vault PKI certificate monitoring
# Place this file in /etc/netdata/health.d/vault-pki.conf

# Alert when certificates are expiring within 30 days
alarm: vault_pki_certificate_expiring_30d
    on: prometheus_vault_pki_exporter.x509_cert_expiry
  calc: $x509_cert_expiry
 units: seconds
 every: 5m
  warn: $this < 30*24*60*60 AND $this > 7*24*60*60
  crit: $this < 7*24*60*60
 delay: down 15m multiplier 1.5 max 1h
  info: Vault PKI certificate will expire in $value seconds (less than 30 days)
    to: sysadmin

# Alert when certificate errors occur
alarm: vault_pki_certificate_errors
    on: prometheus_vault_pki_exporter.x509_cert_error
  calc: $x509_cert_error
 units: errors
 every: 1m
  warn: $this > 0
  crit: $this > 5
 delay: down 5m multiplier 1.5 max 30m
  info: Vault PKI exporter reported $value certificate errors
    to: sysadmin

# Alert when vault-pki-exporter service is down
alarm: vault_pki_exporter_down
    on: prometheus_vault_pki_exporter.up
  calc: $up
 units: status
 every: 1m
  crit: $this != 1
 delay: down 5m multiplier 1.5 max 30m
  info: Vault PKI exporter service is down
    to: sysadmin

# Alert for stale metrics (no updates for more than 10 minutes)
alarm: vault_pki_metrics_stale
    on: prometheus_vault_pki_exporter.x509_cert_expiry
  calc: $now - $last_collected_t
 units: seconds
 every: 1m
  warn: $this > 600
  crit: $this > 1800
 delay: down 5m multiplier 1.5 max 30m
  info: Vault PKI metrics have not been updated for $value seconds
    to: sysadmin
